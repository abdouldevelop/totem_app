# ===================================
# CONFIGURATION NGINX POUR DIGITAL SIGNAGE
# ===================================
# Ce fichier doit être copié dans /etc/nginx/sites-available/digital-signage
# puis créer un lien symbolique dans /etc/nginx/sites-enabled/

# Redirection HTTP vers HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name votre-domaine.com www.votre-domaine.com;

    # Rediriger tout le trafic HTTP vers HTTPS
    return 301 https://$server_name$request_uri;
}

# Configuration HTTPS
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name votre-domaine.com www.votre-domaine.com;

    # Certificats SSL (Let's Encrypt recommandé)
    ssl_certificate /etc/letsencrypt/live/votre-domaine.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/votre-domaine.com/privkey.pem;

    # Configuration SSL moderne et sécurisée
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Headers de sécurité
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Taille maximale des uploads (pour les vidéos et images)
    client_max_body_size 100M;

    # Logs
    access_log /var/log/nginx/digital-signage-access.log;
    error_log /var/log/nginx/digital-signage-error.log;

    # Servir les fichiers statiques directement
    location /static/ {
        alias /chemin/vers/digital_signage_project/backend/staticfiles/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Servir les fichiers média directement
    location /media/ {
        alias /chemin/vers/digital_signage_project/backend/media/;
        expires 7d;
        add_header Cache-Control "public";
    }

    # Proxy vers l'application Django (Gunicorn)
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts pour les requêtes longues
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}

# ===================================
# INSTRUCTIONS D'INSTALLATION
# ===================================
# 1. Remplacez 'votre-domaine.com' par votre vrai nom de domaine
# 2. Remplacez '/chemin/vers/digital_signage_project' par le chemin réel
# 3. Copiez ce fichier : sudo cp nginx.conf.example /etc/nginx/sites-available/digital-signage
# 4. Créez le lien symbolique : sudo ln -s /etc/nginx/sites-available/digital-signage /etc/nginx/sites-enabled/
# 5. Installez Let's Encrypt : sudo apt install certbot python3-certbot-nginx
# 6. Obtenez un certificat SSL : sudo certbot --nginx -d votre-domaine.com -d www.votre-domaine.com
# 7. Testez la configuration : sudo nginx -t
# 8. Rechargez Nginx : sudo systemctl reload nginx
